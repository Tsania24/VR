<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escape Room with Physics</title>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
  <script src="js/controller-listener.js"></script>
  <script src="js/player-move.js"></script>
  <script src="js/raycaster-extras.js"></script>
</head>

<script>
// Fungsi untuk menampilkan pesan teks di VR
function showMessage(message) {
    const messageBox = document.querySelector('#message-box');
    messageBox.setAttribute('text', 'value', message);
    
    setTimeout(() => {
        messageBox.setAttribute('text', 'value', '');
    }, 3000);
}

// Fungsi untuk menampilkan panel UI dengan pesan
function showPanelMessage(message) {
    const panel = document.querySelector('#message-panel');
    const text = document.querySelector('#message-text');
    
    text.setAttribute('value', message);
    panel.setAttribute('visible', true);

    setTimeout(() => {
        panel.setAttribute('visible', false);
    }, 3000);
}

// Komponen pintu interaktif
AFRAME.registerComponent('interactive-door', {
    schema: {
        open: {type: 'boolean', default: false},
        locked: {type: 'boolean', default: true},
        correctCode: {type: 'string', default: '1234'}
    },
    init: function () {
        const doorEl = this.el;
        this.el.addEventListener('click', () => {
            if (this.data.locked) {
                const userCode = prompt('The door is locked. Enter the code to unlock:');
                if (userCode === this.data.correctCode) {
                    showPanelMessage('Correct code! The door is now unlocked.');
                    this.data.locked = false;
                } else {
                    showPanelMessage('Incorrect code. Try again.');
                }
            } else {
                this.data.open = !this.data.open;
                doorEl.setAttribute('animation', 'property: rotation; to: 0 15 0; dur: 1000');
            }
        });
    }
});

// Komponen pengambil kunci
AFRAME.registerComponent('key-collector', {
    init: function () {
        this.el.addEventListener('click', () => {
            showPanelMessage('You found the key! Now find the code to unlock the door.');
            this.el.parentNode.removeChild(this.el);
        });
    }
});

// Komponen pengambil kode
AFRAME.registerComponent('code-collector', {
    init: function () {
        this.el.addEventListener('click', () => {
            showPanelMessage('You found the code! Use it along with the key to unlock the door.');
            this.el.parentNode.removeChild(this.el);
        });
    }
});

// Komponen buku kosong
AFRAME.registerComponent('bk-collector', {
    init: function () {
        this.el.addEventListener('click', () => {
            showMessage('This book is empty. Try another one.');
            this.el.parentNode.removeChild(this.el);
        });
    }
});

// Komponen buku dengan kode acak
AFRAME.registerComponent('book-collector', {
    schema: {
        correctCode: {type: 'string', default: '1234'}
    },
    init: function () {
        const randomCode = Math.floor(Math.random() * 9000 + 1000).toString();
        this.el.addEventListener('click', () => {
            showPanelMessage('You found a book! The code is: ' + randomCode);
            const doorEl = document.querySelector('[interactive-door]');
            doorEl.setAttribute('interactive-door', 'correctCode', randomCode);
            this.el.parentNode.removeChild(this.el);
        });
    }
});

// Komponen untuk randomisasi kode buku
AFRAME.registerComponent('random-code-books', {
    init: function () {
        const books = [
            {el: document.querySelector('#book1')},
            {el: document.querySelector('#book2')},
            {el: document.querySelector('#book3')},
            {el: document.querySelector('#book4')},
            {el: document.querySelector('#book5')}
        ];

        const randomIndex = Math.floor(Math.random() * books.length);
        const validBook = books[randomIndex];
        const randomCode = Math.floor(Math.random() * 9000 + 1000).toString();

        books.forEach(book => {
            if (book === validBook) {
                book.el.setAttribute('book-collector', 'correctCode', randomCode);
            } else {
                book.el.setAttribute('bk-collector', 'correctCode', '');
            }
        });

        console.log(`The correct code is on the book with ID: ${validBook.el.id}, Code: ${randomCode}`);
    }
});
</script>

<style>
  body {
    margin: 0;
    overflow: hidden;
  }
</style>

<body>
<a-scene random-code-books>
    <!-- Pesan dalam dunia VR -->
    <a-text id="message-box" position="0 2 -2" align="center" color="red" width="3"></a-text>

    <!-- Panel UI untuk pesan -->
    <a-plane id="message-panel" position="0 2 -2" width="2" height="1.2" color="black" visible="false">
        <a-text id="message-text" value="" align="center" color="white" position="0 0 0.1" width="1.8"></a-text>
    </a-plane>

    <a-gltf-model src="onlyRoom.glb" position="0 0 0" scale="1 1 1"></a-gltf-model>

    <a-gltf-model src="onlyDoor.glb" position="0 0 0" scale="1 1 1" interactive-door></a-gltf-model>

    <a-gltf-model src="KeyBlade.glb" position="2.5 1.8 -1.2" scale="-1 -1 -1" key-collector></a-gltf-model>

    <a-plane id="code-card" position="1 2.5 -4" width="0.6" height="0.6" color="white"
             text="value: Take it! and find the code; align: center; color: black; baseline: top; wrap-count: 12;"
             code-collector></a-plane>

    <a-gltf-model id="book1" src="book.glb" position="2.6 0.9 -3.8" scale="-1 -1 -1" class="book" bk-collector></a-gltf-model>
    <a-gltf-model id="book2" src="bukubuka.glb" position="2.5 0.8 -1.3" scale="-1 -1 -1" class="book" bk-collector></a-gltf-model>

    <a-entity id="camera" camera="userHeight: 1.6" look-controls position="0 1.6 0">
        <a-cursor></a-cursor>
    </a-entity>

    <a-sky color="#87CEEB"></a-sky>
</a-scene>
</body>
</html>
