<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Escape Room with Physics</title>
  <!-- A-Frame Library -->
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <!-- A-Frame Extras (optional, for physics or additional features) -->
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.0.0/dist/aframe-extras.min.js"></script>
  <script src="js/controller-listener.js"></script>
  <script src="js/player-move.js"></script>
  <script src="js/raycaster-extras.js"></script>
</head>

<script>
    // Register interactive door component
    AFRAME.registerComponent('interactive-door', {
    schema: {
        open: {type: 'boolean', default: false},
        locked: {type: 'boolean', default: true},
        correctCode: {type: 'string', default: '1234'} // Default code can be set here
    },
    init: function () {
        const doorEl = this.el;
        this.el.addEventListener('click', () => {
            if (this.data.locked) {
                const userCode = prompt('The door is locked. Enter the code to unlock:');
                // Check if the entered code matches the door's correct code
                if (userCode === this.data.correctCode) {
                    alert('Correct code! The door is now unlocked.');
                    this.data.locked = false;
                } else {
                    alert('Incorrect code. Try again.');
                }
            } else {
                this.data.open = !this.data.open;
                doorEl.setAttribute('animation', 'property: rotation; to: 0 15 0; dur: 1000');
            }
        });
    }
});

    // Register key collector component
    AFRAME.registerComponent('key-collector', {
        init: function () {
            this.el.addEventListener('click', () => {
                alert('You found the key! Now find the code to unlock the door.');
                this.el.parentNode.removeChild(this.el);
            });
        }
    });

    // Register code collector component
    AFRAME.registerComponent('code-collector', {
        init: function () {
            this.el.addEventListener('click', () => {
                alert('You found the code! Use it along with the key to unlock the door.');
                this.el.parentNode.removeChild(this.el);
            });
        }
    });

    // Register bk-collector component for empty code books
    AFRAME.registerComponent('bk-collector', {
        init: function () {
            this.el.addEventListener('click', () => {
              const bookCollector = this.el.getAttribute('book-collector');
            
            if (!bookCollector) {
                // Jika tidak ada komponen 'book-collector', jalankan fungsinya
                alert('This book is empty. Try another one.');
                this.el.parentNode.removeChild(this.el);  // Remove book after being clicked
            }
            });
        }
    });

    // Register book component for random code
    AFRAME.registerComponent('book-collector', {
    schema: {
        correctCode: {type: 'string', default: '1234'}
    },
    init: function () {
        const randomCode = Math.floor(Math.random() * 9000 + 1000).toString(); // Random 4-digit code
        this.el.addEventListener('click', () => {
            alert('You found a book! The code is: ' + randomCode);
            // Update the correctCode of the door based on the book code
            const doorEl = document.querySelector('[interactive-door]'); // Get the door element
            doorEl.setAttribute('interactive-door', 'correctCode', randomCode); // Update door code
            this.el.parentNode.removeChild(this.el);
        });
      }
  });


    // Register random code books component
    AFRAME.registerComponent('random-code-books', {
        init: function () {
            // List of books (5 books)
            const books = [
                {el: document.querySelector('#book1')},
                {el: document.querySelector('#book2')},
                {el: document.querySelector('#book3')},
                {el: document.querySelector('#book4')},
                {el: document.querySelector('#book5')}
            ];

            // Randomly select one book to have a valid random code
            const randomIndex = Math.floor(Math.random() * books.length);
            const validBook = books[randomIndex];

            // Generate a random 4-digit code
            const randomCode = Math.floor(Math.random() * 9000 + 1000).toString();

            // Assign a valid random code to the random book, and empty code to others
            books.forEach(book => {
                if (book === validBook) {
                    book.el.setAttribute('book-collector', 'correctCode', randomCode);
                } else {
                    book.el.setAttribute('bk-collector', 'correctCode', '');
                }
            });

            // Log the valid code for debugging
            console.log(`The correct code is on the book with ID: ${validBook.el.id}, Code: ${randomCode}`);
        }
    });
  </script>
  
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    a-scene {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>
  <!-- A-Frame Scene -->
  <a-scene random-code-books>

    <a-entity 
    id="player" 
    position="0 0 0" 
    player-move="controllerListenerId: #controller-data;
                 navigationMeshClass: environmentGround;">
    
    <a-camera></a-camera>

    <a-entity 
        id="controller-data" 
        controller-listener="leftControllerId:  #left-controller; 
                             rightControllerId: #right-controller;">
    </a-entity>

    <a-entity 
        id="left-controller"
        oculus-touch-controls="hand: left">
    </a-entity>

    <a-entity
        id="right-controller"
        oculus-touch-controls="hand: right"
        raycaster="objects: .raycaster-target, .environmentGround;"
        raycaster-extras="controllerListenerId: #controller-data;">
    </a-entity>

</a-entity>


    <a-assets>
      <audio id="lagu" src="room.mp3"></audio>
    </a-assets>

    <!-- Load the 3D Model -->
    <a-gltf-model 
      src="onlyRoom.glb" 
      position="0 0 0" 
      scale="1 1 1">
    </a-gltf-model>

    <a-text value="Find a key and take it!"
      position="0 2.7 -3"
      rotation="0 0 0"
      width="2"
      color="black">
    </a-text>

    <!-- 3D Model Pintu -->
    <a-gltf-model 
    src="onlyDoor.glb" 
    position="0 0 0" 
    scale="1 1 1"
    interactive-door>
  </a-gltf-model>

    <!-- Interactive Key -->
    <a-gltf-model 
      src="KeyBlade.glb" 
      position="2.5 1.8 -1.2" 
      scale="-1 -1 -1"
      key-collector>
    </a-gltf-model>

    <!-- Code Card -->
    <a-plane id="code-card" 
      position="1 2.5 -4" 
      width="0.6" 
      height="0.6" 
      color="#FFFFFF" 
      text="value: Take it! and find the code; align: center; color: black; baseline: top; wrap-count: 12;"
      code-collector>
    </a-plane>

    <!-- Add Books -->
    <a-gltf-model 
      id="book1"
      src="book.glb" 
      position="2.6 0.9 -3.8" 
      scale="-1 -1 -1"
      class="book"
      bk-collector>
    </a-gltf-model>

    <a-gltf-model 
      id="book2"
      src="bukubuka.glb" 
      position="2.5 0.8 -1.3" 
      scale="-1 -1 -1"
      class="book"
      bk-collector>
    </a-gltf-model>

    <a-gltf-model 
      id="book3"
      src="book2.glb" 
      position="-2.7 0.09 -1" 
      scale="-1 -1 -1"
      class="book"
      bk-collector>
    </a-gltf-model>

    <a-gltf-model 
      id="book4"
      src="book3.glb" 
      position="-3.8 0.1 0.4" 
      scale="-1 -1 -1"
      class="book"
      bk-collector>
    </a-gltf-model>

    <a-gltf-model 
      id="book5"
      src="bukubuka1.glb" 
      position="-1.5 1 -1.8" 
      scale="-1 -1 -1"
      class="book"
      bk-collector>
    </a-gltf-model>

    <!-- Camera and Cursor -->
    <a-entity id="camera" 
      camera="userHeight: 1.6" 
      look-controls 
      position="0 1.6 0">
      <a-cursor></a-cursor>
    </a-entity>

    <!-- Sky -->
    <a-sky color="#87CEEB" src="#lagu" autoplay="true" loop="true"></a-sky>

  </a-scene>
</body>
</html>
